name: Deploy to ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. ä»£ç éªŒè¯Jobï¼ˆè½»é‡çº§ï¼‰
  validate:
    name: Code Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Remove pnpm lock file
        run: rm -f pnpm-lock.yaml

      - name: Install dependencies (validation only)
        run: npm install

      - name: Type check
        run: npm run type-check

      - name: Lint check
        run: npm run lint || echo "Lintæ£€æŸ¥å®Œæˆï¼ˆå…è®¸è­¦å‘Šï¼‰"

  # 2. è§¦å‘ECSæœ¬åœ°æ„å»ºå’Œéƒ¨ç½²Job
  deploy:
    name: ECS Local Build and Deploy
    runs-on: ubuntu-latest
    needs: validate
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²æˆ–æ‰‹åŠ¨è§¦å‘æ—¶
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to ECS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            #!/bin/bash
            set -e

            echo "ğŸš€ å¼€å§‹ECSæœ¬åœ°æ„å»ºéƒ¨ç½²æµç¨‹..."
            echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"

            # å®šä¹‰å˜é‡
            PROJECT_DIR="/www/wwwroot/easy-erp-web"

            # 1. åœæ­¢å½“å‰åº”ç”¨
            echo "â¹ï¸  åœæ­¢å½“å‰åº”ç”¨..."
            pm2 stop easy-erp-web || true
            pm2 delete easy-erp-web || true

            # åˆ›å»ºå’Œè¿›å…¥é¡¹ç›®ç›®å½•
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1

            # 2. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            if [ ! -d ".git" ]; then
              echo "ğŸ”— åˆå§‹åŒ–Gitä»“åº“..."
              git clone git@github.com:rn1024/easy-erp-web.git .
            else
              echo "ğŸ”„ æ›´æ–°ç°æœ‰ä»“åº“..."

              # ç¡®ä¿ä½¿ç”¨SSHè¿œç¨‹URL
              current_url=$(git remote get-url origin)
              if [[ "$current_url" == https://github.com/* ]]; then
                echo "ğŸ”§ æ›´æ”¹è¿œç¨‹URLä¸ºSSHæ–¹å¼..."
                git remote set-url origin git@github.com:rn1024/easy-erp-web.git
                echo "âœ… è¿œç¨‹URLå·²æ›´æ–°ä¸ºSSH"
              fi

              git fetch origin
              git reset --hard origin/main

              # å¤„ç†.user.iniæ–‡ä»¶æƒé™é—®é¢˜
              if [ -f ".user.ini" ]; then
                echo "ğŸ”§ å¤„ç†.user.iniæ–‡ä»¶æƒé™..."
                chattr -i .user.ini 2>/dev/null || true
                echo "âœ… .user.iniæƒé™å·²å¤„ç†"
              fi

              git clean -fd
            fi

            echo "âœ… å½“å‰ä»£ç ç‰ˆæœ¬: $(git log --oneline -1)"

            # 3. è®¾ç½®npmæº
            echo "ğŸ”§ é…ç½®npmæº..."
            npm config set registry https://registry.npmmirror.com
            echo "âœ… npmæºé…ç½®å®Œæˆ"

            # 4. æ¸…ç†æ—§æ–‡ä»¶
            echo "ğŸ—‘ï¸  æ¸…ç†æ—§çš„ä¾èµ–å’Œæ„å»ºäº§ç‰©..."
            rm -rf node_modules
            rm -rf .next
            rm -f package-lock.json
            npm cache clean --force
            echo "âœ… æ¸…ç†å®Œæˆ"

            # 5. è®¾ç½®ç¯å¢ƒå˜é‡
            echo "âš™ï¸  é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡..."
            cat > .env << 'EOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}
            OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}
            OSS_BUCKET=${{ secrets.OSS_BUCKET }}
            OSS_REGION=${{ secrets.OSS_REGION }}
            OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com
            NEXT_PUBLIC_APP_URL=https://erp.samuelcn.com
            OSS_PATH_PREFIX=template
            NODE_ENV=production
            PORT=3008
            EOF
            echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

            # 6. å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
            npm install --production=false

            # éªŒè¯å…³é”®ä¾èµ–
            if [ ! -f "node_modules/.bin/next" ]; then
              echo "âŒ Next.js æœªæ­£ç¡®å®‰è£…"
              exit 1
            fi
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

            # 7. ç”ŸæˆPrismaå®¢æˆ·ç«¯
            echo "ğŸ—„ï¸  ç”ŸæˆPrismaå®¢æˆ·ç«¯..."
            npm run db:generate
            echo "âœ… Prismaå®¢æˆ·ç«¯ç”Ÿæˆå®Œæˆ"

            # 7.5. æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®åº“
            echo "ğŸ—„ï¸  æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€..."
            
            # æ£€æŸ¥æ•°æ®åº“è¿æ¥
            echo "ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥..."
            if ! node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.\$queryRaw\`SELECT 1\`.then(() => { console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ'); process.exit(0); }).catch(err => { console.error('æ•°æ®åº“è¿æ¥å¤±è´¥:', err.message); process.exit(1); }).finally(() => prisma.\$disconnect());"; then
              echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œç»ˆæ­¢éƒ¨ç½²"
              exit 1
            fi
            
            # æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
            echo "ğŸ” æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„..."
            TABLE_COUNT=$(node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.\$queryRaw\`SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = DATABASE() AND table_type = 'BASE TABLE'\`.then(result => { console.log(result[0].count); process.exit(0); }).catch(err => { console.log('0'); process.exit(0); }).finally(() => prisma.\$disconnect());")
            echo "ğŸ“Š æ•°æ®åº“ä¸­å…±æœ‰ $TABLE_COUNT ä¸ªè¡¨"
            
            # æ£€æŸ¥å…³é”®è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆåŒ…æ‹¬æ–°å¢çš„ product_costs è¡¨ï¼‰
            echo "ğŸ” æ£€æŸ¥å…³é”®è¡¨æ˜¯å¦å­˜åœ¨..."
            CRITICAL_TABLES=("accounts" "roles" "permissions" "shops" "suppliers" "product_costs" "product_info" "purchase_orders")
            MISSING_TABLES=()
            
            for table in "${CRITICAL_TABLES[@]}"; do
              if ! node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.\$queryRaw\`SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = '${table}'\`.then(result => { if(result[0].count === 0) { console.log('MISSING'); process.exit(1); } else { console.log('EXISTS'); process.exit(0); } }).catch(err => { console.log('ERROR'); process.exit(1); }).finally(() => prisma.\$disconnect());"; then
                echo "âš ï¸  è¡¨ $table ä¸å­˜åœ¨"
                MISSING_TABLES+=("$table")
              else
                echo "âœ… è¡¨ $table å­˜åœ¨"
              fi
            done
            
            # æ ¹æ®è¡¨æ•°é‡å’Œç¼ºå¤±è¡¨æƒ…å†µå†³å®šåˆå§‹åŒ–ç­–ç•¥
            if [ "$TABLE_COUNT" -eq "0" ]; then
              echo "ğŸ†• æ£€æµ‹åˆ°ç©ºæ•°æ®åº“ï¼Œæ‰§è¡Œå®Œæ•´åˆå§‹åŒ–..."
              
              # å¯¹äºç©ºæ•°æ®åº“ï¼Œç›´æ¥ä½¿ç”¨ db push ç¡®ä¿å®Œæ•´åŒæ­¥
              echo "ğŸ“¦ ä½¿ç”¨ Prisma DB Push åˆå§‹åŒ–æ•°æ®åº“..."
              npx prisma db push --force-reset
              
            elif [ ${#MISSING_TABLES[@]} -gt 0 ]; then
              echo "âš ï¸  æ£€æµ‹åˆ°ç¼ºå¤±è¡¨: ${MISSING_TABLES[*]}"
              echo "ğŸ”§ ä½¿ç”¨ Prisma DB Push å¼ºåˆ¶åŒæ­¥æ•°æ®åº“ç»“æ„..."
              
              # ä½¿ç”¨ db push å¼ºåˆ¶åŒæ­¥ schemaï¼Œç¡®ä¿æ‰€æœ‰è¡¨éƒ½è¢«åˆ›å»º
              npx prisma db push
              
            elif [ "$TABLE_COUNT" -lt "29" ]; then
              echo "âš ï¸  æ•°æ®åº“è¡¨æ•°é‡ä¸å®Œæ•´ï¼ˆ$TABLE_COUNT/29ï¼‰ï¼Œå¼ºåˆ¶åŒæ­¥..."
              
              # ä½¿ç”¨ db push ç¡®ä¿è¡¨ç»“æ„å®Œæ•´
              echo "ğŸ”§ å¼ºåˆ¶åŒæ­¥æ•°æ®åº“ç»“æ„..."
              npx prisma db push
              
            else
              echo "âœ… æ•°æ®åº“è¡¨ç»“æ„å®Œæ•´ï¼ˆ$TABLE_COUNT ä¸ªè¡¨ï¼‰"
              
              # å³ä½¿è¡¨æ•°é‡æ­£ç¡®ï¼Œä¹Ÿè¦ç¡®ä¿æ²¡æœ‰ç¼ºå¤±å…³é”®è¡¨
              if [ ${#MISSING_TABLES[@]} -eq 0 ]; then
                echo "ğŸ”„ ç¡®ä¿æ•°æ®åº“ä¸ºæœ€æ–°çŠ¶æ€..."
                npm run db:init-empty
              else
                echo "ğŸ”§ å‘ç°ç¼ºå¤±å…³é”®è¡¨ï¼Œæ‰§è¡ŒåŒæ­¥..."
                npx prisma db push
              fi
            fi
            
            # åŒæ­¥åé‡æ–°éªŒè¯å…³é”®è¡¨
            echo "ğŸ” éªŒè¯å…³é”®è¡¨åˆ›å»ºç»“æœ..."
            for table in "${CRITICAL_TABLES[@]}"; do
              if ! node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.\$queryRaw\`SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = '${table}'\`.then(result => { if(result[0].count === 0) { console.error('è¡¨ ${table} ä»ç„¶ä¸å­˜åœ¨'); process.exit(1); } else { console.log('âœ… è¡¨ ${table} éªŒè¯é€šè¿‡'); process.exit(0); } }).catch(err => { console.error('æ£€æŸ¥è¡¨å¤±è´¥:', err.message); process.exit(1); }).finally(() => prisma.\$disconnect());"; then
                echo "âŒ å…³é”®è¡¨ $table åˆ›å»ºå¤±è´¥"
                exit 1
              fi
            done
            
            echo "âœ… æ‰€æœ‰å…³é”®è¡¨éªŒè¯é€šè¿‡"
            
            echo "âœ… æ•°æ®åº“ç»“æ„åˆå§‹åŒ–å®Œæˆ"
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦ç§å­æ•°æ®
            echo "ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦ç§å­æ•°æ®..."
            if node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.role.count().then(count => { if(count === 0) { console.log('NEED_SEED'); process.exit(1); } else { console.log('DATA_EXISTS'); } }).catch(() => { console.log('NEED_SEED'); process.exit(1); }).finally(() => prisma.\$disconnect());"; then
              echo "âœ… æ•°æ®åº“å·²æœ‰åŸºç¡€æ•°æ®"
            else
              echo "ğŸŒ± æ•°æ®åº“éœ€è¦åˆå§‹åŒ–ç§å­æ•°æ®..."
              npm run db:seed:production
              echo "âœ… æ•°æ®åº“ç§å­æ•°æ®åˆå§‹åŒ–å®Œæˆ"
            fi
            
            # æœ€ç»ˆéªŒè¯æ•°æ®åº“çŠ¶æ€
            echo "ğŸ” æœ€ç»ˆéªŒè¯æ•°æ®åº“çŠ¶æ€..."
            FINAL_TABLE_COUNT=$(node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.\$queryRaw\`SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = DATABASE() AND table_type = 'BASE TABLE'\`.then(result => { console.log(result[0].count); process.exit(0); }).catch(err => { console.log('0'); process.exit(0); }).finally(() => prisma.\$disconnect());")
            ROLE_COUNT=$(node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.role.count().then(count => { console.log(count); process.exit(0); }).catch(err => { console.log('0'); process.exit(0); }).finally(() => prisma.\$disconnect());")
            ACCOUNT_COUNT=$(node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.account.count().then(count => { console.log(count); process.exit(0); }).catch(err => { console.log('0'); process.exit(0); }).finally(() => prisma.\$disconnect());")
            
            # éªŒè¯å…³é”®è¡¨æ˜¯å¦å­˜åœ¨
            PRODUCT_COSTS_EXISTS=$(node -e "const { PrismaClient } = require('./generated/prisma'); const prisma = new PrismaClient(); prisma.\$queryRaw\`SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 'product_costs'\`.then(result => { console.log(result[0].count > 0 ? 'YES' : 'NO'); process.exit(0); }).catch(err => { console.log('NO'); process.exit(0); }).finally(() => prisma.\$disconnect());")
            
            echo "ğŸ“Š æ•°æ®åº“æœ€ç»ˆçŠ¶æ€:"
            echo "  - è¡¨æ•°é‡: $FINAL_TABLE_COUNT"
            echo "  - è§’è‰²æ•°é‡: $ROLE_COUNT"
            echo "  - è´¦æˆ·æ•°é‡: $ACCOUNT_COUNT"
            echo "  - product_costsè¡¨: $PRODUCT_COSTS_EXISTS"
            
            if [ "$FINAL_TABLE_COUNT" -lt "29" ] || [ "$ROLE_COUNT" -eq "0" ] || [ "$PRODUCT_COSTS_EXISTS" = "NO" ]; then
              echo "âŒ æ•°æ®åº“çŠ¶æ€éªŒè¯å¤±è´¥"
              if [ "$PRODUCT_COSTS_EXISTS" = "NO" ]; then
                echo "âŒ product_costs è¡¨ç¼ºå¤±"
              fi
              exit 1
            fi

            # 8. æ•°æ®åº“å‡†å¤‡å®Œæˆ
            echo "âœ… æ•°æ®åº“å‡†å¤‡å®Œæˆ"

            # 8.5. åˆ›å»ºuploadç›®å½•ç»“æ„
            echo "ğŸ“ åˆ›å»ºuploadç›®å½•ç»“æ„..."
            mkdir -p upload/{images,videos,documents,avatars,accessories,labels,shipments}
            echo "âœ… uploadç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

            # 9. æ„å»ºåº”ç”¨ï¼ˆä½¿ç”¨standaloneæ¨¡å¼ï¼‰
            echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨..."
            npm run build:standalone

            # 10. éªŒè¯æ„å»ºäº§ç‰©ï¼ˆå¢å¼ºstandaloneéªŒè¯ï¼‰
            echo "âœ… éªŒè¯æ„å»ºäº§ç‰©..."
            if [ ! -d ".next" ]; then
              echo "âŒ .nextç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -f ".next/BUILD_ID" ]; then
              echo "âŒ BUILD_IDæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            # Standaloneæ¨¡å¼ç‰¹æœ‰éªŒè¯
            if [ ! -f ".next/standalone/server.js" ]; then
              echo "âŒ standalone/server.jsä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -d ".next/standalone/.next/static" ]; then
              echo "âŒ standaloneé™æ€èµ„æºç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -d ".next/standalone/public" ]; then
              echo "âŒ standalone publicç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -f ".next/standalone/public/favicon.ico" ]; then
              echo "âŒ favicon.icoä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            BUILD_SIZE=$(du -sh .next | cut -f1)
            STANDALONE_SIZE=$(du -sh .next/standalone | cut -f1)
            echo "âœ… æ„å»ºäº§ç‰©å¤§å°: $BUILD_SIZE"
            echo "âœ… Standaloneå¤§å°: $STANDALONE_SIZE"
            echo "âœ… Standaloneæ¨¡å¼æ„å»ºéªŒè¯é€šè¿‡"

            # 11. æ£€æŸ¥ç«¯å£å¹¶é‡Šæ”¾
            echo "ğŸ” æ£€æŸ¥ç«¯å£3008çŠ¶æ€..."
            if netstat -tlnp | grep :3008; then
              echo "âš ï¸  ç«¯å£3008è¢«å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
              lsof -ti:3008 | xargs kill -9 2>/dev/null || true
              sleep 3
              echo "âœ… ç«¯å£å·²é‡Šæ”¾"
            else
              echo "âœ… ç«¯å£3008ç©ºé—²"
            fi

            # 12. é…ç½®Nginxï¼ˆå¦‚æœé…ç½®æ–‡ä»¶å­˜åœ¨ï¼‰
            if [ -f "nginx/erp.samuelcn.com.conf" ]; then
              echo "ğŸŒ é…ç½®Nginx..."
              mkdir -p /etc/nginx/sites-available
              mkdir -p /etc/nginx/sites-enabled
              cp nginx/erp.samuelcn.com.conf /etc/nginx/sites-available/
              ln -sf /etc/nginx/sites-available/erp.samuelcn.com.conf /etc/nginx/sites-enabled/

              # æµ‹è¯•nginxé…ç½®
              if nginx -t; then
                nginx -s reload
                echo "âœ… Nginxé…ç½®æ›´æ–°æˆåŠŸ"
              else
                echo "âš ï¸  Nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼Œè·³è¿‡é‡è½½"
              fi
            else
              echo "â„¹ï¸  æœªæ‰¾åˆ°Nginxé…ç½®æ–‡ä»¶ï¼Œè·³è¿‡é…ç½®"
            fi

            # 12.5. ä¿®å¤nginxä»£ç†ç¼“å­˜é—®é¢˜
            echo "ğŸ”§ æ£€æŸ¥nginxä»£ç†ç¼“å­˜é…ç½®..."
            PROXY_CONF_DIR="/www/server/panel/vhost/nginx/proxy/erp.samuelcn.com"
            if [ -d "$PROXY_CONF_DIR" ]; then
              for conf_file in "$PROXY_CONF_DIR"/*.conf; do
                if [ -f "$conf_file" ]; then
                  if ! grep -q "proxy_cache off" "$conf_file"; then
                    echo "ğŸ”§ æ·»åŠ nginxä»£ç†ç¼“å­˜ç¦ç”¨é…ç½®åˆ° $conf_file..."
                    sed -i '/proxy_http_version 1.1;/a\    proxy_cache off;' "$conf_file"
                    echo "âœ… nginxä»£ç†ç¼“å­˜é…ç½®å·²æ›´æ–°"
                  else
                    echo "âœ… nginxä»£ç†ç¼“å­˜é…ç½®å·²å­˜åœ¨"
                  fi
                fi
              done

              # æ¸…ç†ç°æœ‰ä»£ç†ç¼“å­˜
              if [ -d "/www/server/nginx/proxy_cache_dir" ]; then
                echo "ğŸ—‘ï¸  æ¸…ç†nginxä»£ç†ç¼“å­˜..."
                rm -rf /www/server/nginx/proxy_cache_dir/*
                echo "âœ… nginxä»£ç†ç¼“å­˜å·²æ¸…ç†"
              fi

              # é‡è½½nginxé…ç½®ä»¥åº”ç”¨æ›´æ”¹
              if nginx -t; then
                nginx -s reload
                echo "âœ… nginxä»£ç†é…ç½®å·²é‡è½½"
              fi
            else
              echo "âš ï¸  nginxä»£ç†é…ç½®ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡é…ç½®"
            fi

            # 12.8. éªŒè¯PM2é…ç½®
            echo "ğŸ”§ éªŒè¯PM2é…ç½®..."
            if [ ! -f "ecosystem.config.js" ]; then
              echo "âŒ ecosystem.config.js ç¼ºå¤±"
              exit 1
            fi

            # æ£€æŸ¥PM2é…ç½®æ˜¯å¦ä½¿ç”¨standaloneæ¨¡å¼
            if grep -q "\.next/standalone/server\.js" ecosystem.config.js; then
              echo "âœ… PM2é…ç½®ä½¿ç”¨standaloneæ¨¡å¼"
            else
              echo "âŒ PM2é…ç½®æœªä½¿ç”¨standaloneæ¨¡å¼"
              exit 1
            fi

            # 12.9. å¯åŠ¨å‰æœ€ç»ˆæ£€æŸ¥
            echo "ğŸ” å¯åŠ¨å‰æœ€ç»ˆæ£€æŸ¥..."
            if [ ! -f ".next/standalone/server.js" ]; then
              echo "âŒ standalone/server.jsç¼ºå¤±ï¼Œæ— æ³•å¯åŠ¨"
              exit 1
            fi

            if [ ! -d ".next/standalone/.next/static" ]; then
              echo "âŒ é™æ€èµ„æºç¼ºå¤±ï¼Œæ— æ³•å¯åŠ¨"
              exit 1
            fi

            echo "âœ… å¯åŠ¨å‰æ£€æŸ¥é€šè¿‡"

            # 13. å¯åŠ¨åº”ç”¨
            echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            echo "âœ… PM2å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"

            # 14. ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
            echo "â³ ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨ï¼ˆ15ç§’ï¼‰..."
            sleep 15

            # 15. éªŒè¯åº”ç”¨çŠ¶æ€
            echo "ğŸ” éªŒè¯åº”ç”¨çŠ¶æ€..."
            pm2 status

            if pm2 status | grep easy-erp-web | grep -q online; then
              echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"
            else
              echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              pm2 logs easy-erp-web --lines 20
              exit 1
            fi

            # 16. æœ¬åœ°å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ‰§è¡Œæœ¬åœ°å¥åº·æ£€æŸ¥..."
            for i in {1..6}; do
              echo "ğŸ” å¥åº·æ£€æŸ¥å°è¯• $i/6..."
              if curl -f -s --max-time 10 "http://localhost:3008/api/health" > /dev/null; then
                echo "âœ… æœ¬åœ°å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                if [ $i -eq 6 ]; then
                  echo "âŒ æœ¬åœ°å¥åº·æ£€æŸ¥å¤±è´¥"
                  echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼š"
                  pm2 logs easy-erp-web --lines 30
                  exit 1
                else
                  echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
                  sleep 5
                fi
              fi
            done

            # 17. æ£€æŸ¥å…³é”®æ¥å£
            echo "ğŸ§ª æ£€æŸ¥å…³é”®æ¥å£..."
            if curl -f -s --max-time 10 "http://localhost:3008/api/v1/auth/verifycode" > /dev/null; then
              echo "âœ… éªŒè¯ç æ¥å£æ­£å¸¸"
            else
              echo "âš ï¸  éªŒè¯ç æ¥å£å¼‚å¸¸ï¼Œä½†ç»§ç»­éƒ¨ç½²"
            fi

            echo ""
            echo "ğŸ‰ ECSæœ¬åœ°æ„å»ºéƒ¨ç½²å®Œæˆï¼"
            echo "==============================================="
            echo "ğŸ“Š éƒ¨ç½²ç»“æœï¼š"
            echo "  ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
            echo "  ğŸ—ï¸  æ„å»ºå¤§å°: $BUILD_SIZE"
            echo "  ğŸŒ åº”ç”¨åœ°å€: https://erp.samuelcn.com"
            echo "  ğŸ“ Gitç‰ˆæœ¬: $(git log --oneline -1)"
            echo "==============================================="

  # 3. è¿œç¨‹éªŒè¯Job
  verify:
    name: Remote Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Wait for service stabilization
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡ç¨³å®šï¼ˆ30ç§’ï¼‰..."
          sleep 30

      - name: Remote health check
        run: |
          echo "ğŸ” è¿œç¨‹å¥åº·æ£€æŸ¥..."

          MAX_RETRIES=10
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ” å¥åº·æ£€æŸ¥å°è¯• $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 15 \
              --connect-timeout 5 \
              "https://erp.samuelcn.com/api/health" 2>/dev/null || echo "000")

            echo "ğŸ“¡ å¥åº·æ£€æŸ¥å“åº”ç : $response"

            if [ "$response" = "200" ]; then
              echo "âœ… è¿œç¨‹å¥åº·æ£€æŸ¥æˆåŠŸï¼"
              SUCCESS=true
              break
            else
              echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $response)ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ è¿œç¨‹å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            exit 1
          fi

      - name: Functional verification
        run: |
          echo "ğŸ§ª åŠŸèƒ½æ¥å£éªŒè¯..."

          # æµ‹è¯•å…³é”®æ¥å£
          endpoints=(
            "https://erp.samuelcn.com/api/health"
            "https://erp.samuelcn.com/api/v1/auth/verifycode"
          )

          for endpoint in "${endpoints[@]}"; do
            echo "ğŸ“¡ æµ‹è¯• $endpoint"
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --connect-timeout 5 \
              "$endpoint" 2>/dev/null || echo "000")

            if [ "$status" = "200" ]; then
              echo "âœ… $endpoint æ­£å¸¸ (HTTP $status)"
            else
              echo "âš ï¸  $endpoint å¼‚å¸¸ (HTTP $status)"
            fi
          done

      - name: Performance check
        run: |
          echo "âš¡ æ€§èƒ½æ£€æŸ¥..."

          start_time=$(date +%s%N)
          curl -s --max-time 10 "https://erp.samuelcn.com/api/health" > /dev/null
          end_time=$(date +%s%N)

          duration=$((($end_time - $start_time) / 1000000))
          echo "ğŸ“Š å“åº”æ—¶é—´: ${duration}ms"

          if [ $duration -lt 3000 ]; then
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸"
          else
            echo "âš ï¸  å“åº”æ—¶é—´è¾ƒæ…¢"
          fi

      - name: Final deployment status
        run: |
          echo ""
          echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"
          echo "==============================================="
          echo "âœ… ECSæœ¬åœ°æ„å»ºéƒ¨ç½²æˆåŠŸ"
          echo "âœ… è¿œç¨‹å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "âœ… å…³é”®æ¥å£éªŒè¯å®Œæˆ"
          echo "ğŸŒ åº”ç”¨åœ°å€: https://erp.samuelcn.com"
          echo "ğŸ“Š éªŒè¯æ—¶é—´: $(date)"
          echo "==============================================="

      - name: Troubleshoot on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ” æ•…éšœæ’æŸ¥..."

            echo "ğŸ“Š PM2çŠ¶æ€ï¼š"
            pm2 status

            echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰ï¼š"
            pm2 logs easy-erp-web --lines 50 2>/dev/null || echo "æ— æ³•è·å–PM2æ—¥å¿—"

            echo "ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
            netstat -tlnp | grep :3008 || echo "ç«¯å£3008æœªç›‘å¬"

            echo "ğŸ³ Dockerå®¹å™¨çŠ¶æ€ï¼š"
            docker ps -a | grep mysql || echo "MySQLå®¹å™¨æœªè¿è¡Œ"

            echo "ğŸ”„ å°è¯•é‡å¯åº”ç”¨ï¼š"
            pm2 restart easy-erp-web
            sleep 10
            pm2 status

            echo "ğŸ“Š éƒ¨ç½²æ•…éšœæ’æŸ¥å®Œæˆ"
