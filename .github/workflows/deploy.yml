name: Deploy to ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. æ„å»ºå’Œæµ‹è¯• Job
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # ä¸ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é”æ–‡ä»¶å†²çª

      - name: Remove pnpm lock file
        run: rm -f pnpm-lock.yaml

      - name: Install dependencies
        run: npm install

      - name: Setup environment variables
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}" >> .env
          echo "OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}" >> .env
          echo "OSS_BUCKET=${{ secrets.OSS_BUCKET }}" >> .env
          echo "OSS_REGION=${{ secrets.OSS_REGION }}" >> .env
          echo "OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com" >> .env
          echo "NEXT_PUBLIC_APP_URL=https://erp.samuelcn.com" >> .env
          echo "OSS_PATH_PREFIX=template" >> .env
          echo "NODE_ENV=production" >> .env
          echo "PORT=3008" >> .env

      - name: Type check
        run: npm run type-check

      - name: Build application
        run: npm run build

      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -la .next/
          ls -la .next/BUILD_ID
          echo "Build verification complete"

      - name: Compress .next directory
        run: |
          echo "Compressing .next directory..."
          tar -czf next-build.tar.gz .next/
          ls -la next-build.tar.gz
          echo "Compression complete"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            next-build.tar.gz
            package.json
            package-lock.json
            ecosystem.config.js
            prisma
            generated
            next.config.js
            tsconfig.json
            public
            scripts
          retention-days: 1

  # 2. æ‰“åŒ… Job
  package:
    name: Create Deployment Package
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files

      - name: Extract .next directory
        run: |
          echo "Extracting .next directory from compressed file..."
          if [ -f "next-build.tar.gz" ]; then
            tar -xzf next-build.tar.gz
            echo "âœ… .next directory extracted successfully"
            ls -la .next/
            ls -la .next/BUILD_ID
          else
            echo "âŒ next-build.tar.gz not found"
            exit 1
          fi

      - name: Debug - Check downloaded files
        run: |
          echo "Current working directory:"
          pwd
          echo "List all files and directories:"
          ls -la
          echo "Check if .next directory exists:"
          ls -la .next || echo ".next directory not found"
          echo "Check if package.json exists:"
          ls -la package.json || echo "package.json not found"

      - name: Generate production environment file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env.production
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env.production
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.production
          echo "OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}" >> .env.production
          echo "OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}" >> .env.production
          echo "OSS_BUCKET=${{ secrets.OSS_BUCKET }}" >> .env.production
          echo "OSS_REGION=${{ secrets.OSS_REGION }}" >> .env.production
          echo "OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com" >> .env.production
          echo "NEXT_PUBLIC_APP_URL=https://erp.samuelcn.com" >> .env.production
          echo "OSS_PATH_PREFIX=template" >> .env.production
          echo "NODE_ENV=production" >> .env.production
          echo "PORT=3008" >> .env.production

      - name: Create deployment package
        run: |
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åˆ›å»ºéƒ¨ç½²åŒ…
          echo "Creating deployment package..."

          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥ç»„ç»‡æ–‡ä»¶
          mkdir -p deploy-temp

          # å¤åˆ¶å­˜åœ¨çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          if [ -d ".next" ]; then
            cp -r .next deploy-temp/
          else
            echo "Warning: .next directory not found"
          fi

          if [ -f "package.json" ]; then
            cp package.json deploy-temp/
          else
            echo "Warning: package.json not found"
          fi

          if [ -f "package-lock.json" ]; then
            cp package-lock.json deploy-temp/
            echo "âœ… package-lock.json included"
          else
            echo "âŒ ERROR: package-lock.json not found - this is required for consistent npm installs"
            exit 1
          fi

          if [ -f "ecosystem.config.js" ]; then
            cp ecosystem.config.js deploy-temp/
          else
            echo "Warning: ecosystem.config.js not found"
          fi

          if [ -d "prisma" ]; then
            cp -r prisma deploy-temp/
          else
            echo "Warning: prisma directory not found"
          fi

          if [ -d "generated" ]; then
            cp -r generated deploy-temp/
          else
            echo "Warning: generated directory not found"
          fi

          if [ -f "next.config.js" ]; then
            cp next.config.js deploy-temp/
          else
            echo "Warning: next.config.js not found"
          fi

          if [ -f "tsconfig.json" ]; then
            cp tsconfig.json deploy-temp/
          else
            echo "Warning: tsconfig.json not found"
          fi

          if [ -d "public" ]; then
            cp -r public deploy-temp/
          else
            echo "Warning: public directory not found"
          fi

          # å¤åˆ¶scriptsç›®å½•
          if [ -d "scripts" ]; then
            cp -r scripts deploy-temp/
            echo "âœ… scriptsç›®å½•å·²åŒ…å«"
          else
            echo "Warning: scripts directory not found"
          fi

          # å¤åˆ¶nginxé…ç½®æ–‡ä»¶
          if [ -d "nginx" ]; then
            cp -r nginx deploy-temp/
            echo "âœ… Nginxé…ç½®æ–‡ä»¶å·²åŒ…å«"
          else
            echo "Warning: nginx directory not found"
          fi

          # å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
          cp .env.production deploy-temp/

          # åˆ—å‡ºä¸´æ—¶ç›®å½•å†…å®¹
          echo "Contents of deploy-temp:"
          ls -la deploy-temp/

          # ä»ä¸´æ—¶ç›®å½•åˆ›å»ºtaråŒ…
          cd deploy-temp
          tar -czf ../deploy.tar.gz .
          cd ..

          # éªŒè¯taråŒ…
          echo "Verifying tar package:"
          tar -tzf deploy.tar.gz | head -20

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy.tar.gz
          retention-days: 1

  # 3. éƒ¨ç½² Job
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: package
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²æˆ–æ‰‹åŠ¨è§¦å‘æ—¶
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Upload to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          source: deploy.tar.gz
          target: /tmp/
          overwrite: true

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            # åˆ›å»ºé¡¹ç›®ç›®å½•
            mkdir -p /www/wwwroot/easy-erp-web

            # åœæ­¢å¹¶åˆ é™¤æ—§çš„PM2è¿›ç¨‹ï¼ˆç¡®ä¿ç«¯å£æ›´æ”¹ç”Ÿæ•ˆï¼‰
            pm2 stop easy-erp-web || true
            pm2 delete easy-erp-web || true

            # ç®€å•å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆä»…ç”¨äºç´§æ€¥æƒ…å†µï¼‰
            if [ -f "/www/wwwroot/easy-erp-web/package.json" ]; then
              echo "ğŸ“¦ åˆ›å»ºå½“å‰ç‰ˆæœ¬å¤‡ä»½..."
              rm -rf /www/wwwroot/easy-erp-web-last-backup 2>/dev/null || true
              cp -r /www/wwwroot/easy-erp-web /www/wwwroot/easy-erp-web-last-backup
              echo "âœ… å¤‡ä»½å®Œæˆ: /www/wwwroot/easy-erp-web-last-backup"
            else
              echo "â„¹ï¸  æœªå‘ç°ç°æœ‰ç‰ˆæœ¬ï¼Œè·³è¿‡å¤‡ä»½"
            fi

            # æ¸…ç©ºé¡¹ç›®ç›®å½•ï¼Œå‡†å¤‡éƒ¨ç½²æ–°ç‰ˆæœ¬
            rm -rf /www/wwwroot/easy-erp-web/*
            echo "âœ… é¡¹ç›®ç›®å½•å·²æ¸…ç©º"

            # è§£å‹æ–°ç‰ˆæœ¬
            cd /www/wwwroot/easy-erp-web
            tar -xzf /tmp/deploy.tar.gz
            rm -f /tmp/deploy.tar.gz

            # éªŒè¯è§£å‹ç»“æœ
            echo "éªŒè¯è§£å‹ç»“æœ..."
            ls -la
            if [ -d ".next" ]; then
              echo "âœ… .nextç›®å½•å­˜åœ¨"
              ls -la .next/
              if [ -f ".next/BUILD_ID" ]; then
                echo "âœ… BUILD_IDæ–‡ä»¶å­˜åœ¨"
              else
                echo "âŒ BUILD_IDæ–‡ä»¶ç¼ºå¤±"
              fi
            else
              echo "âŒ .nextç›®å½•ä¸å­˜åœ¨"
            fi

            # è®¾ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶
            cp .env.production .env

            # é…ç½®nginx
            if [ -f "nginx/erp.samuelcn.com.conf" ]; then
              echo "é…ç½®nginx..."
              mkdir -p /etc/nginx/sites-available
              mkdir -p /etc/nginx/sites-enabled
              cp nginx/erp.samuelcn.com.conf /etc/nginx/sites-available/
              ln -sf /etc/nginx/sites-available/erp.samuelcn.com.conf /etc/nginx/sites-enabled/

              # æµ‹è¯•nginxé…ç½®
              nginx -t && echo "âœ… Nginxé…ç½®æ­£ç¡®" || echo "âŒ Nginxé…ç½®é”™è¯¯"
            fi

            # å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆæœåŠ¡å™¨ä½¿ç”¨npmï¼‰
            npm install --production --omit=dev

            # éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å®‰è£…æˆåŠŸ
            if [ ! -f "node_modules/.bin/next" ]; then
              echo "âš ï¸  Next.js æœªæ­£ç¡®å®‰è£…ï¼Œå°è¯•å®Œæ•´å®‰è£…..."
              npm install
            fi

            # æ£€æŸ¥.nextç›®å½•æ˜¯å¦å®Œæ•´ï¼Œå¦‚æœä¸å®Œæ•´åˆ™é‡æ–°æ„å»º
            if [ ! -f ".next/BUILD_ID" ] || [ ! -d ".next/server" ]; then
              echo "âš ï¸  .nextç›®å½•ä¸å®Œæ•´ï¼Œå¼€å§‹é‡æ–°æ„å»º..."
              npm install
              npm run build
              echo "âœ… é‡æ–°æ„å»ºå®Œæˆ"
            else
              echo "âœ… .nextç›®å½•å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
            fi

                        # æ£€æŸ¥MySQLå’ŒRedisè¿æ¥
            echo "ğŸ” æ£€æŸ¥æ•°æ®åº“å’ŒRedisè¿æ¥..."
            if [ -f "scripts/check-connections.js" ]; then
              node scripts/check-connections.js
              if [ $? -eq 0 ]; then
                echo "âœ… æ‰€æœ‰æœåŠ¡è¿æ¥æ­£å¸¸"
              else
                echo "âŒ éƒ¨åˆ†æœåŠ¡è¿æ¥å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²..."
                echo "âš ï¸  è¯·æ£€æŸ¥ä»¥ä¸‹æœåŠ¡çŠ¶æ€ï¼š"
                echo "  ğŸ“¦ Dockerå®¹å™¨çŠ¶æ€ï¼š"
                docker ps | grep -E "(mysql|redis)" || echo "    - æœªæ‰¾åˆ°MySQL/Rediså®¹å™¨"
                echo "  ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
                netstat -tlnp | grep :3306 || echo "    - MySQLç«¯å£3306æœªç›‘å¬"
                netstat -tlnp | grep :6379 || echo "    - Redisç«¯å£6379æœªç›‘å¬"
              fi
            else
              echo "âš ï¸  è¿æ¥æ£€æŸ¥è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡è¿æ¥æµ‹è¯•"
            fi

            # æ•°æ®åº“è¿ç§»
            echo "ğŸ—„ï¸  å¼€å§‹æ•°æ®åº“è¿ç§»..."
            npx prisma generate
            npx prisma db push

            # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨åˆ™é‡Šæ”¾
            PORT_IN_USE=$(netstat -tlnp 2>/dev/null | grep ":3008 " | wc -l)
            if [ "$PORT_IN_USE" -gt 0 ]; then
              echo "ç«¯å£ 3008 è¢«å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
              lsof -ti:3008 | xargs kill -9 2>/dev/null || true
              sleep 3
            fi

            # å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰
            pm2 start ecosystem.config.js --env production

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # é‡è½½ nginx
            if command -v nginx >/dev/null 2>&1; then
              nginx -t && nginx -s reload && echo "âœ… Nginxé‡è½½æˆåŠŸ" || echo "âŒ Nginxé‡è½½å¤±è´¥"
            fi

            # æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
            pm2 status

  # 4. éƒ¨ç½²åéªŒè¯ Job
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 5 # ç¼©çŸ­jobè¶…æ—¶æ—¶é—´ä¸º5åˆ†é’Ÿ

    steps:
      - name: Health check
        timeout-minutes: 4 # ä¸ºå•æ­¥è®¾ç½®è¶…æ—¶
        run: |
          echo "ğŸš€ å¼€å§‹åº”ç”¨å¥åº·æ£€æŸ¥..."

          # å‡å°‘ç­‰å¾…æ—¶é—´åˆ°20ç§’
          echo "â³ ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨ï¼ˆ20ç§’ï¼‰..."
          sleep 20

          # å¥åº·æ£€æŸ¥é‡è¯•æœºåˆ¶
          MAX_RETRIES=6
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ” å°è¯•å¥åº·æ£€æŸ¥ $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            # è®°å½•å¼€å§‹æ—¶é—´
            start_time=$(date +%s)

            # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€ï¼ˆä½¿ç”¨HTTPSï¼Œç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼‰
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 8 \
              --connect-timeout 3 \
              --retry 0 \
              "https://erp.samuelcn.com/api/health" 2>/dev/null || echo "000")

            # è®°å½•ç»“æŸæ—¶é—´
            end_time=$(date +%s)
            duration=$((end_time - start_time))

            echo "ğŸ“¡ å¥åº·æ£€æŸ¥å“åº”ç : $response (è€—æ—¶: ${duration}ç§’)"

            if [ "$response" = "200" ]; then
              echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥æˆåŠŸï¼"

              # é¢å¤–éªŒè¯ï¼šæ£€æŸ¥éªŒè¯ç æ¥å£
              echo "ğŸ” éªŒè¯å…³é”®æ¥å£..."
              verify_response=$(curl -s -o /dev/null -w "%{http_code}" \
                --max-time 5 \
                --connect-timeout 3 \
                "https://erp.samuelcn.com/api/v1/auth/verifycode" 2>/dev/null || echo "000")

              echo "ğŸ“¡ éªŒè¯ç æ¥å£å“åº”ç : $verify_response"

              if [ "$verify_response" = "200" ]; then
                echo "âœ… å…³é”®æ¥å£éªŒè¯æˆåŠŸï¼"
                SUCCESS=true
                break
              else
                echo "âš ï¸  å…³é”®æ¥å£éªŒè¯å¤±è´¥ï¼Œä½†å¥åº·æ£€æŸ¥é€šè¿‡"
                SUCCESS=true
                break
              fi
            else
              echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $response)ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            echo "ğŸ” æœ€åä¸€æ¬¡è¯Šæ–­ä¿¡æ¯ï¼š"
            echo "  - æœ€ç»ˆå“åº”ç : $response"
            echo "  - æ€»é‡è¯•æ¬¡æ•°: $RETRY_COUNT"
            echo "  - æ£€æŸ¥URL: https://erp.samuelcn.com/api/health"
            exit 1
          fi

          echo "ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡ï¼"

      - name: Final verification
        timeout-minutes: 1
        run: |
          echo "ğŸ” æœ€ç»ˆéªŒè¯éƒ¨ç½²çŠ¶æ€..."

          # å¿«é€ŸéªŒè¯ä¸»è¦ç«¯ç‚¹
          endpoints=(
            "https://erp.samuelcn.com/api/health"
            "https://erp.samuelcn.com/api/v1/auth/verifycode"
          )

          for endpoint in "${endpoints[@]}"; do
            echo "ğŸ“¡ æ£€æŸ¥ $endpoint ..."
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 5 \
              --connect-timeout 2 \
              "$endpoint" 2>/dev/null || echo "000")

            if [ "$status" = "200" ]; then
              echo "âœ… $endpoint æ­£å¸¸ (HTTP $status)"
            else
              echo "âš ï¸  $endpoint å¼‚å¸¸ (HTTP $status)"
            fi
          done

          echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"

      - name: Troubleshoot on failure
        if: failure()
        timeout-minutes: 2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ” å¿«é€Ÿæ•…éšœæ’æŸ¥..."

            echo "ğŸ“Š PM2çŠ¶æ€ï¼š"
            pm2 status

            echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰ï¼š"
            pm2 logs easy-erp-web --lines 20 2>/dev/null || echo "æ— æ³•è·å–PM2æ—¥å¿—"

            echo "ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
            netstat -tlnp | grep :3008 || echo "ç«¯å£3008æœªç›‘å¬"

            echo "ğŸ³ Dockerå®¹å™¨çŠ¶æ€ï¼š"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(mysql|redis)" || echo "æœªæ‰¾åˆ°æ•°æ®åº“å®¹å™¨"

            echo "ğŸ”„ å°è¯•é‡å¯åº”ç”¨ï¼š"
            pm2 restart easy-erp-web || echo "é‡å¯å¤±è´¥"

            echo "â³ ç­‰å¾…é‡å¯ï¼ˆ10ç§’ï¼‰ï¼š"
            sleep 10
            pm2 status

      - name: Notify deployment status
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "âœ… åº”ç”¨å·²æˆåŠŸéƒ¨ç½²å¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
          echo "ğŸŒ åº”ç”¨åœ°å€: https://erp.samuelcn.com"
          echo "ğŸ“Š éªŒè¯æ—¶é—´: $(date)"
