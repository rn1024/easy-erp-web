name: Deploy to ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. ä»£ç éªŒè¯Jobï¼ˆè½»é‡çº§ï¼‰
  validate:
    name: Code Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Remove pnpm lock file
        run: rm -f pnpm-lock.yaml

      - name: Install dependencies (validation only)
        run: npm install

      - name: Type check
        run: npm run type-check

      - name: Lint check
        run: npm run lint || echo "Lintæ£€æŸ¥å®Œæˆï¼ˆå…è®¸è­¦å‘Šï¼‰"

  # 2. è§¦å‘ECSæœ¬åœ°æ„å»ºå’Œéƒ¨ç½²Job
  deploy:
    name: ECS Local Build and Deploy
    runs-on: ubuntu-latest
    needs: validate
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²æˆ–æ‰‹åŠ¨è§¦å‘æ—¶
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to ECS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            #!/bin/bash
            set -e

            echo "ğŸš€ å¼€å§‹ECSæœ¬åœ°æ„å»ºéƒ¨ç½²æµç¨‹..."
            echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"

            # å®šä¹‰å˜é‡
            PROJECT_DIR="/www/wwwroot/easy-erp-web"
            BACKUP_DIR="/www/wwwroot/easy-erp-web-backup-$(date +%Y%m%d-%H%M%S)"

            # 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "$PROJECT_DIR" ] && [ -f "$PROJECT_DIR/package.json" ]; then
              echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ° $BACKUP_DIR"
              cp -r "$PROJECT_DIR" "$BACKUP_DIR"
              echo "âœ… å¤‡ä»½å®Œæˆ"
            else
              echo "â„¹ï¸  æœªå‘ç°ç°æœ‰ç‰ˆæœ¬ï¼Œè·³è¿‡å¤‡ä»½"
            fi

            # 2. åœæ­¢å½“å‰åº”ç”¨
            echo "â¹ï¸  åœæ­¢å½“å‰åº”ç”¨..."
            pm2 stop easy-erp-web || true
            pm2 delete easy-erp-web || true

            # 3. åˆ›å»ºå’Œè¿›å…¥é¡¹ç›®ç›®å½•
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1

            # 4. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            if [ ! -d ".git" ]; then
              echo "ğŸ”— åˆå§‹åŒ–Gitä»“åº“..."
              git clone https://github.com/rn1024/easy-erp-web.git .
            else
              echo "ğŸ”„ æ›´æ–°ç°æœ‰ä»“åº“..."
              git fetch origin
              git reset --hard origin/main
              
              # å¤„ç†.user.iniæ–‡ä»¶æƒé™é—®é¢˜
              if [ -f ".user.ini" ]; then
                echo "ğŸ”§ å¤„ç†.user.iniæ–‡ä»¶æƒé™..."
                chattr -i .user.ini 2>/dev/null || true
                echo "âœ… .user.iniæƒé™å·²å¤„ç†"
              fi
              
              git clean -fd
            fi

            echo "âœ… å½“å‰ä»£ç ç‰ˆæœ¬: $(git log --oneline -1)"

            # 5. è®¾ç½®npmæ·˜å®æº
            echo "ğŸ”§ é…ç½®npmæ·˜å®æº..."
            npm config set registry https://registry.npmmirror.com
            npm config set disturl https://npmmirror.com/dist
            npm config set electron_mirror https://npmmirror.com/mirrors/electron/
            npm config set sass_binary_site https://npmmirror.com/mirrors/node-sass/
            npm config set phantomjs_cdnurl https://npmmirror.com/mirrors/phantomjs/
            npm config set chromedriver_cdnurl https://npmmirror.com/mirrors/chromedriver/
            npm config set operadriver_cdnurl https://npmmirror.com/mirrors/operadriver/
            npm config set fse_binary_host_mirror https://npmmirror.com/mirrors/fsevents/
            echo "âœ… npmæºé…ç½®å®Œæˆ"

            # 6. æ¸…ç†æ—§æ–‡ä»¶
            echo "ğŸ—‘ï¸  æ¸…ç†æ—§çš„ä¾èµ–å’Œæ„å»ºäº§ç‰©..."
            rm -rf node_modules
            rm -rf .next
            rm -f package-lock.json
            npm cache clean --force
            echo "âœ… æ¸…ç†å®Œæˆ"

            # 7. è®¾ç½®ç¯å¢ƒå˜é‡
            echo "âš™ï¸  é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡..."
            cat > .env << 'EOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}
            OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}
            OSS_BUCKET=${{ secrets.OSS_BUCKET }}
            OSS_REGION=${{ secrets.OSS_REGION }}
            OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com
            NEXT_PUBLIC_APP_URL=https://erp.samuelcn.com
            OSS_PATH_PREFIX=template
            NODE_ENV=production
            PORT=3008
            EOF
            echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

            # 8. å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
            npm install --production=false

            # éªŒè¯å…³é”®ä¾èµ–
            if [ ! -f "node_modules/.bin/next" ]; then
              echo "âŒ Next.js æœªæ­£ç¡®å®‰è£…"
              exit 1
            fi
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

            # 9. ç”ŸæˆPrismaå®¢æˆ·ç«¯
            echo "ğŸ—„ï¸  ç”ŸæˆPrismaå®¢æˆ·ç«¯..."
            npm run db:generate
            echo "âœ… Prismaå®¢æˆ·ç«¯ç”Ÿæˆå®Œæˆ"

            # 10. æ•°æ®åº“è¿ç§»
            echo "ğŸ—„ï¸  æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
            npm run db:sync-migrate
            echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

            # 11. æ„å»ºåº”ç”¨
            echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨..."
            npm run build

            # 12. éªŒè¯æ„å»ºäº§ç‰©
            echo "âœ… éªŒè¯æ„å»ºäº§ç‰©..."
            if [ ! -d ".next" ]; then
              echo "âŒ .nextç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -f ".next/BUILD_ID" ]; then
              echo "âŒ BUILD_IDæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -d ".next/server" ]; then
              echo "âŒ serverç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            if [ ! -d ".next/static" ]; then
              echo "âŒ staticç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
              exit 1
            fi

            BUILD_SIZE=$(du -sh .next | cut -f1)
            echo "âœ… æ„å»ºäº§ç‰©å¤§å°: $BUILD_SIZE"
            echo "âœ… æ„å»ºå®Œæˆï¼ŒéªŒè¯é€šè¿‡"

            # 13. æ£€æŸ¥ç«¯å£å¹¶é‡Šæ”¾
            echo "ğŸ” æ£€æŸ¥ç«¯å£3008çŠ¶æ€..."
            if netstat -tlnp | grep :3008; then
              echo "âš ï¸  ç«¯å£3008è¢«å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
              lsof -ti:3008 | xargs kill -9 2>/dev/null || true
              sleep 3
              echo "âœ… ç«¯å£å·²é‡Šæ”¾"
            else
              echo "âœ… ç«¯å£3008ç©ºé—²"
            fi

            # 14. é…ç½®Nginxï¼ˆå¦‚æœé…ç½®æ–‡ä»¶å­˜åœ¨ï¼‰
            if [ -f "nginx/erp.samuelcn.com.conf" ]; then
              echo "ğŸŒ é…ç½®Nginx..."
              mkdir -p /etc/nginx/sites-available
              mkdir -p /etc/nginx/sites-enabled
              cp nginx/erp.samuelcn.com.conf /etc/nginx/sites-available/
              ln -sf /etc/nginx/sites-available/erp.samuelcn.com.conf /etc/nginx/sites-enabled/
              
              # æµ‹è¯•nginxé…ç½®
              if nginx -t; then
                nginx -s reload
                echo "âœ… Nginxé…ç½®æ›´æ–°æˆåŠŸ"
              else
                echo "âš ï¸  Nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼Œè·³è¿‡é‡è½½"
              fi
            else
              echo "â„¹ï¸  æœªæ‰¾åˆ°Nginxé…ç½®æ–‡ä»¶ï¼Œè·³è¿‡é…ç½®"
            fi

            # 15. å¯åŠ¨åº”ç”¨
            echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            echo "âœ… PM2å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"

            # 16. ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
            echo "â³ ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨ï¼ˆ15ç§’ï¼‰..."
            sleep 15

            # 17. éªŒè¯åº”ç”¨çŠ¶æ€
            echo "ğŸ” éªŒè¯åº”ç”¨çŠ¶æ€..."
            pm2 status

            if pm2 status | grep easy-erp-web | grep -q online; then
              echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"
            else
              echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              pm2 logs easy-erp-web --lines 20
              exit 1
            fi

            # 18. æœ¬åœ°å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ‰§è¡Œæœ¬åœ°å¥åº·æ£€æŸ¥..."
            for i in {1..6}; do
              echo "ğŸ” å¥åº·æ£€æŸ¥å°è¯• $i/6..."
              if curl -f -s --max-time 10 "http://localhost:3008/api/health" > /dev/null; then
                echo "âœ… æœ¬åœ°å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                if [ $i -eq 6 ]; then
                  echo "âŒ æœ¬åœ°å¥åº·æ£€æŸ¥å¤±è´¥"
                  echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼š"
                  pm2 logs easy-erp-web --lines 30
                  exit 1
                else
                  echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
                  sleep 5
                fi
              fi
            done

            # 19. æ£€æŸ¥å…³é”®æ¥å£
            echo "ğŸ§ª æ£€æŸ¥å…³é”®æ¥å£..."
            if curl -f -s --max-time 10 "http://localhost:3008/api/v1/auth/verifycode" > /dev/null; then
              echo "âœ… éªŒè¯ç æ¥å£æ­£å¸¸"
            else
              echo "âš ï¸  éªŒè¯ç æ¥å£å¼‚å¸¸ï¼Œä½†ç»§ç»­éƒ¨ç½²"
            fi

            echo ""
            echo "ğŸ‰ ECSæœ¬åœ°æ„å»ºéƒ¨ç½²å®Œæˆï¼"
            echo "==============================================="
            echo "ğŸ“Š éƒ¨ç½²ç»“æœï¼š"
            echo "  ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
            echo "  ğŸ—ï¸  æ„å»ºå¤§å°: $BUILD_SIZE"
            echo "  ğŸŒ åº”ç”¨åœ°å€: https://erp.samuelcn.com"
            echo "  ğŸ“ Gitç‰ˆæœ¬: $(git log --oneline -1)"
            echo "==============================================="

            # 20. æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
            echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶..."
            cd /www/wwwroot/
            ls -t easy-erp-web-backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            echo "âœ… å¤‡ä»½æ¸…ç†å®Œæˆ"

  # 3. è¿œç¨‹éªŒè¯Job
  verify:
    name: Remote Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Wait for service stabilization
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡ç¨³å®šï¼ˆ30ç§’ï¼‰..."
          sleep 30

      - name: Remote health check
        run: |
          echo "ğŸ” è¿œç¨‹å¥åº·æ£€æŸ¥..."

          MAX_RETRIES=10
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ” å¥åº·æ£€æŸ¥å°è¯• $(($RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 15 \
              --connect-timeout 5 \
              "https://erp.samuelcn.com/api/health" 2>/dev/null || echo "000")
            
            echo "ğŸ“¡ å¥åº·æ£€æŸ¥å“åº”ç : $response"
            
            if [ "$response" = "200" ]; then
              echo "âœ… è¿œç¨‹å¥åº·æ£€æŸ¥æˆåŠŸï¼"
              SUCCESS=true
              break
            else
              echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $response)ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ è¿œç¨‹å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            exit 1
          fi

      - name: Functional verification
        run: |
          echo "ğŸ§ª åŠŸèƒ½æ¥å£éªŒè¯..."

          # æµ‹è¯•å…³é”®æ¥å£
          endpoints=(
            "https://erp.samuelcn.com/api/health"
            "https://erp.samuelcn.com/api/v1/auth/verifycode"
          )

          for endpoint in "${endpoints[@]}"; do
            echo "ğŸ“¡ æµ‹è¯• $endpoint"
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --connect-timeout 5 \
              "$endpoint" 2>/dev/null || echo "000")
              
            if [ "$status" = "200" ]; then
              echo "âœ… $endpoint æ­£å¸¸ (HTTP $status)"
            else
              echo "âš ï¸  $endpoint å¼‚å¸¸ (HTTP $status)"
            fi
          done

      - name: Performance check
        run: |
          echo "âš¡ æ€§èƒ½æ£€æŸ¥..."

          start_time=$(date +%s%N)
          curl -s --max-time 10 "https://erp.samuelcn.com/api/health" > /dev/null
          end_time=$(date +%s%N)

          duration=$((($end_time - $start_time) / 1000000))
          echo "ğŸ“Š å“åº”æ—¶é—´: ${duration}ms"

          if [ $duration -lt 3000 ]; then
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸"
          else
            echo "âš ï¸  å“åº”æ—¶é—´è¾ƒæ…¢"
          fi

      - name: Final deployment status
        run: |
          echo ""
          echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"
          echo "==============================================="
          echo "âœ… ECSæœ¬åœ°æ„å»ºéƒ¨ç½²æˆåŠŸ"
          echo "âœ… è¿œç¨‹å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "âœ… å…³é”®æ¥å£éªŒè¯å®Œæˆ"
          echo "ğŸŒ åº”ç”¨åœ°å€: https://erp.samuelcn.com"
          echo "ğŸ“Š éªŒè¯æ—¶é—´: $(date)"
          echo "==============================================="

      - name: Troubleshoot on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ” æ•…éšœæ’æŸ¥..."

            echo "ğŸ“Š PM2çŠ¶æ€ï¼š"
            pm2 status

            echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰ï¼š"
            pm2 logs easy-erp-web --lines 50 2>/dev/null || echo "æ— æ³•è·å–PM2æ—¥å¿—"

            echo "ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
            netstat -tlnp | grep :3008 || echo "ç«¯å£3008æœªç›‘å¬"

            echo "ğŸ”„ å°è¯•é‡å¯åº”ç”¨ï¼š"
            pm2 restart easy-erp-web
            sleep 10
            pm2 status
