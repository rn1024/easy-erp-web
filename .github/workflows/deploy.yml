name: Deploy to ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. ä»£ç éªŒè¯Jobï¼ˆè½»é‡çº§ï¼‰
  validate:
    name: Code Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Remove pnpm lock file
        run: rm -f pnpm-lock.yaml

      - name: Install dependencies (validation only)
        run: npm install

      - name: Type check
        run: npm run type-check

      - name: Lint check
        run: npm run lint || echo "Lintæ£€æŸ¥å®Œæˆï¼ˆå…è®¸è­¦å‘Šï¼‰"

  # 2. è§¦å‘ECSæœ¬åœ°æ„å»ºå’Œéƒ¨ç½²Job
  deploy:
    name: ECS Local Build and Deploy
    runs-on: ubuntu-latest
    needs: validate
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²æˆ–æ‰‹åŠ¨è§¦å‘æ—¶
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to ECS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export REDIS_URL="${{ secrets.REDIS_URL }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export OSS_ACCESS_KEY_ID="${{ secrets.OSS_ACCESS_KEY_ID }}"
            export OSS_ACCESS_KEY_SECRET="${{ secrets.OSS_ACCESS_KEY_SECRET }}"
            export OSS_BUCKET="${{ secrets.OSS_BUCKET }}"
            export OSS_REGION="${{ secrets.OSS_REGION }}"
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            PROJECT_DIR="/www/wwwroot/easy-erp-web"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1
            
            # ç¡®ä¿è„šæœ¬å­˜åœ¨å¹¶å¯æ‰§è¡Œ
            if [ ! -f "scripts/deploy-to-ecs.sh" ]; then
              echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: scripts/deploy-to-ecs.sh"
              exit 1
            fi
            
            chmod +x scripts/deploy-to-ecs.sh
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            ./scripts/deploy-to-ecs.sh
  # 3. è¿œç¨‹éªŒè¯Job
  verify:
    name: Remote Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Wait for service stabilization
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡ç¨³å®šï¼ˆ30ç§’ï¼‰..."
          sleep 30

      - name: Remote health check
        run: |
          echo "ğŸ” è¿œç¨‹å¥åº·æ£€æŸ¥..."

          MAX_RETRIES=10
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ” å¥åº·æ£€æŸ¥å°è¯• $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            response=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 15 \
              --connect-timeout 5 \
              "https://erp.samuelcn.com/api/health" 2>/dev/null || echo "000")

            echo "ğŸ“¡ å¥åº·æ£€æŸ¥å“åº”ç : $response"

            if [ "$response" = "200" ]; then
              echo "âœ… è¿œç¨‹å¥åº·æ£€æŸ¥æˆåŠŸï¼"
              SUCCESS=true
              break
            else
              echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $response)ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ è¿œç¨‹å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            exit 1
          fi

      - name: Functional verification
        run: |
          echo "ğŸ§ª åŠŸèƒ½æ¥å£éªŒè¯..."

          # æµ‹è¯•å…³é”®æ¥å£
          endpoints=(
            "https://erp.samuelcn.com/api/health"
            "https://erp.samuelcn.com/api/v1/auth/verifycode"
          )

          for endpoint in "${endpoints[@]}"; do
            echo "ğŸ“¡ æµ‹è¯• $endpoint"
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --connect-timeout 5 \
              "$endpoint" 2>/dev/null || echo "000")

            if [ "$status" = "200" ]; then
              echo "âœ… $endpoint æ­£å¸¸ (HTTP $status)"
            else
              echo "âš ï¸  $endpoint å¼‚å¸¸ (HTTP $status)"
            fi
          done

      - name: Performance check
        run: |
          echo "âš¡ æ€§èƒ½æ£€æŸ¥..."

          start_time=$(date +%s%N)
          curl -s --max-time 10 "https://erp.samuelcn.com/api/health" > /dev/null
          end_time=$(date +%s%N)

          duration=$((($end_time - $start_time) / 1000000))
          echo "ğŸ“Š å“åº”æ—¶é—´: ${duration}ms"

          if [ $duration -lt 3000 ]; then
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸"
          else
            echo "âš ï¸  å“åº”æ—¶é—´è¾ƒæ…¢"
          fi

      - name: Final deployment status
        run: |
          echo ""
          echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"
          echo "==============================================="
          echo "âœ… ECSæœ¬åœ°æ„å»ºéƒ¨ç½²æˆåŠŸ"
          echo "âœ… è¿œç¨‹å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "âœ… å…³é”®æ¥å£éªŒè¯å®Œæˆ"
          echo "ğŸŒ åº”ç”¨åœ°å€: https://erp.samuelcn.com"
          echo "ğŸ“Š éªŒè¯æ—¶é—´: $(date)"
          echo "==============================================="

      - name: Troubleshoot on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ” æ•…éšœæ’æŸ¥..."

            echo "ğŸ“Š PM2çŠ¶æ€ï¼š"
            pm2 status

            echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰ï¼š"
            pm2 logs easy-erp-web --lines 50 2>/dev/null || echo "æ— æ³•è·å–PM2æ—¥å¿—"

            echo "ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
            netstat -tlnp | grep :3008 || echo "ç«¯å£3008æœªç›‘å¬"

            echo "ğŸ³ Dockerå®¹å™¨çŠ¶æ€ï¼š"
            docker ps -a | grep mysql || echo "MySQLå®¹å™¨æœªè¿è¡Œ"

            echo "ğŸ”„ å°è¯•é‡å¯åº”ç”¨ï¼š"
            pm2 restart easy-erp-web
            sleep 10
            pm2 status

            echo "ğŸ“Š éƒ¨ç½²æ•…éšœæ’æŸ¥å®Œæˆ"
