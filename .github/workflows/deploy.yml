name: Deploy to ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. æ„å»ºå’Œæµ‹è¯• Job
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # ä¸ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é”æ–‡ä»¶å†²çª

      - name: Remove pnpm lock file
        run: rm -f pnpm-lock.yaml

      - name: Install dependencies
        run: npm install

      - name: Setup environment variables
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}" >> .env
          echo "OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}" >> .env
          echo "OSS_BUCKET=${{ secrets.OSS_BUCKET }}" >> .env
          echo "OSS_REGION=${{ secrets.OSS_REGION }}" >> .env
          echo "OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com" >> .env
          echo "NEXT_PUBLIC_APP_URL=https://erp.samuelcn.com" >> .env
          echo "OSS_PATH_PREFIX=template" >> .env
          echo "NODE_ENV=production" >> .env
          echo "PORT=3008" >> .env

      - name: Type check
        run: npm run type-check

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            .next
            package.json
            package-lock.json
            ecosystem.config.js
            prisma
            generated
            next.config.js
            tsconfig.json
            public
          retention-days: 1

  # 2. æ‰“åŒ… Job
  package:
    name: Create Deployment Package
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files

      - name: Debug - Check downloaded files
        run: |
          echo "Current working directory:"
          pwd
          echo "List all files and directories:"
          ls -la
          echo "Check if .next directory exists:"
          ls -la .next || echo ".next directory not found"
          echo "Check if package.json exists:"
          ls -la package.json || echo "package.json not found"

      - name: Generate production environment file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env.production
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env.production
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.production
          echo "OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}" >> .env.production
          echo "OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}" >> .env.production
          echo "OSS_BUCKET=${{ secrets.OSS_BUCKET }}" >> .env.production
          echo "OSS_REGION=${{ secrets.OSS_REGION }}" >> .env.production
          echo "OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com" >> .env.production
          echo "NEXT_PUBLIC_APP_URL=https://erp.samuelcn.com" >> .env.production
          echo "OSS_PATH_PREFIX=template" >> .env.production
          echo "NODE_ENV=production" >> .env.production
          echo "PORT=3008" >> .env.production

      - name: Create deployment package
        run: |
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åˆ›å»ºéƒ¨ç½²åŒ…
          echo "Creating deployment package..."

          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥ç»„ç»‡æ–‡ä»¶
          mkdir -p deploy-temp

          # å¤åˆ¶å­˜åœ¨çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          if [ -d ".next" ]; then
            cp -r .next deploy-temp/
          else
            echo "Warning: .next directory not found"
          fi

          if [ -f "package.json" ]; then
            cp package.json deploy-temp/
          else
            echo "Warning: package.json not found"
          fi

          if [ -f "package-lock.json" ]; then
            cp package-lock.json deploy-temp/
            echo "âœ… package-lock.json included"
          else
            echo "âŒ ERROR: package-lock.json not found - this is required for consistent npm installs"
            exit 1
          fi

          if [ -f "ecosystem.config.js" ]; then
            cp ecosystem.config.js deploy-temp/
          else
            echo "Warning: ecosystem.config.js not found"
          fi

          if [ -d "prisma" ]; then
            cp -r prisma deploy-temp/
          else
            echo "Warning: prisma directory not found"
          fi

          if [ -d "generated" ]; then
            cp -r generated deploy-temp/
          else
            echo "Warning: generated directory not found"
          fi

          if [ -f "next.config.js" ]; then
            cp next.config.js deploy-temp/
          else
            echo "Warning: next.config.js not found"
          fi

          if [ -f "tsconfig.json" ]; then
            cp tsconfig.json deploy-temp/
          else
            echo "Warning: tsconfig.json not found"
          fi

          if [ -d "public" ]; then
            cp -r public deploy-temp/
          else
            echo "Warning: public directory not found"
          fi

          # å¤åˆ¶nginxé…ç½®æ–‡ä»¶
          if [ -d "nginx" ]; then
            cp -r nginx deploy-temp/
            echo "âœ… Nginxé…ç½®æ–‡ä»¶å·²åŒ…å«"
          else
            echo "Warning: nginx directory not found"
          fi

          # å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
          cp .env.production deploy-temp/

          # åˆ—å‡ºä¸´æ—¶ç›®å½•å†…å®¹
          echo "Contents of deploy-temp:"
          ls -la deploy-temp/

          # ä»ä¸´æ—¶ç›®å½•åˆ›å»ºtaråŒ…
          cd deploy-temp
          tar -czf ../deploy.tar.gz .
          cd ..

          # éªŒè¯taråŒ…
          echo "Verifying tar package:"
          tar -tzf deploy.tar.gz | head -20

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy.tar.gz
          retention-days: 1

  # 3. éƒ¨ç½² Job
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: package
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Upload to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          source: deploy.tar.gz
          target: /tmp/
          overwrite: true

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            # åˆ›å»ºé¡¹ç›®ç›®å½•
            mkdir -p /www/wwwroot/easy-erp-web

            # åœæ­¢å¹¶åˆ é™¤æ—§çš„PM2è¿›ç¨‹ï¼ˆç¡®ä¿ç«¯å£æ›´æ”¹ç”Ÿæ•ˆï¼‰
            pm2 stop easy-erp-web || true
            pm2 delete easy-erp-web || true

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "/www/wwwroot/easy-erp-web/backup" ]; then
              rm -rf /www/wwwroot/easy-erp-web/backup
            fi
            if [ -f "/www/wwwroot/easy-erp-web/package.json" ]; then
              mkdir -p /www/wwwroot/easy-erp-web/backup
              cp -r /www/wwwroot/easy-erp-web/* /www/wwwroot/easy-erp-web/backup/ 2>/dev/null || true
            fi

            # è§£å‹æ–°ç‰ˆæœ¬
            cd /www/wwwroot/easy-erp-web
            tar -xzf /tmp/deploy.tar.gz
            rm -f /tmp/deploy.tar.gz

            # è®¾ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶
            cp .env.production .env

            # é…ç½®nginx
            if [ -f "nginx/erp.samuelcn.com.conf" ]; then
              echo "é…ç½®nginx..."
              mkdir -p /etc/nginx/sites-available
              mkdir -p /etc/nginx/sites-enabled
              cp nginx/erp.samuelcn.com.conf /etc/nginx/sites-available/
              ln -sf /etc/nginx/sites-available/erp.samuelcn.com.conf /etc/nginx/sites-enabled/

              # æµ‹è¯•nginxé…ç½®
              nginx -t && echo "âœ… Nginxé…ç½®æ­£ç¡®" || echo "âŒ Nginxé…ç½®é”™è¯¯"
            fi

            # å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆæœåŠ¡å™¨ä½¿ç”¨npmï¼‰
            npm install --production --omit=dev

            # æ•°æ®åº“è¿ç§»
            npx prisma generate
            npx prisma db push

            # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨åˆ™é‡Šæ”¾
            PORT_IN_USE=$(netstat -tlnp 2>/dev/null | grep ":3008 " | wc -l)
            if [ "$PORT_IN_USE" -gt 0 ]; then
              echo "ç«¯å£ 3008 è¢«å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
              lsof -ti:3008 | xargs kill -9 2>/dev/null || true
              sleep 3
            fi

            # å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰
            pm2 start ecosystem.config.js --env production

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # é‡è½½ nginx
            if command -v nginx >/dev/null 2>&1; then
              nginx -t && nginx -s reload && echo "âœ… Nginxé‡è½½æˆåŠŸ" || echo "âŒ Nginxé‡è½½å¤±è´¥"
            fi

            # æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
            pm2 status

  # 4. éƒ¨ç½²åéªŒè¯ Job
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10 # è®¾ç½®jobè¶…æ—¶æ—¶é—´

    steps:
      - name: Health check
        run: |
          echo "ğŸš€ å¼€å§‹åº”ç”¨å¥åº·æ£€æŸ¥..."

          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆ60ç§’ï¼‰..."
          sleep 60

          # å¥åº·æ£€æŸ¥é‡è¯•æœºåˆ¶
          MAX_RETRIES=5
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ” å°è¯•å¥åº·æ£€æŸ¥ $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€ï¼ˆå¢åŠ è¶…æ—¶æ—¶é—´ï¼‰
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --connect-timeout 5 "http://erp.samuelcn.com:3008/api/health" 2>/dev/null || echo "000")

            echo "ğŸ“¡ å¥åº·æ£€æŸ¥å“åº”ç : $response"

            if [ "$response" = "200" ]; then
              echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥æˆåŠŸï¼"
              SUCCESS=true
              break
            else
              echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $response)ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥ï¼Œå¼€å§‹æ•…éšœæ’æŸ¥..."
            exit 1
          fi

      - name: Troubleshoot on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ” å¼€å§‹æ•…éšœæ’æŸ¥..."

            echo "ğŸ“Š PM2çŠ¶æ€ï¼š"
            pm2 status

            echo "ğŸ“ åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰ï¼š"
            pm2 logs easy-erp-web --lines 50 || echo "æ— æ³•è·å–PM2æ—¥å¿—"

            echo "ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
            netstat -tlnp | grep :3008 || echo "ç«¯å£3008æœªç›‘å¬"

            echo "ğŸ”¥ ç³»ç»Ÿè¿›ç¨‹ï¼š"
            ps aux | grep easy-erp-web || echo "æœªæ‰¾åˆ°åº”ç”¨è¿›ç¨‹"

            echo "ğŸ’¾ ç£ç›˜ç©ºé—´ï¼š"
            df -h /www/wwwroot/easy-erp-web

            echo "ğŸ”„ å°è¯•é‡å¯åº”ç”¨ï¼š"
            pm2 restart easy-erp-web || echo "é‡å¯å¤±è´¥"

            echo "â³ ç­‰å¾…é‡å¯åå†æ¬¡æ£€æŸ¥ï¼ˆ30ç§’ï¼‰ï¼š"
            sleep 30
            pm2 status

      - name: Notify deployment status
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
            echo "ğŸ“Š åº”ç”¨çŠ¶æ€ï¼š"
            pm2 status
            echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
            df -h /www/wwwroot/easy-erp-web
            echo "ğŸ”„ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
            pm2 logs easy-erp-web --lines 10
