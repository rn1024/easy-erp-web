name: Deploy to ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. æ„å»ºå’Œæµ‹è¯• Job
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Setup environment variables
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}" >> .env
          echo "OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}" >> .env
          echo "OSS_BUCKET=easy-erp-web" >> .env
          echo "OSS_REGION=oss-cn-hangzhou" >> .env
          echo "OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com" >> .env
          echo "OSS_PATH_PREFIX=template" >> .env
          echo "NODE_ENV=production" >> .env
          echo "PORT=3008" >> .env

      - name: Type check
        run: pnpm type-check

      - name: Run tests
        run: pnpm test -- --passWithNoTests

      - name: Build application
        run: pnpm build

      - name: Generate package-lock.json for production
        run: |
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„package-lock.json
          rm -f package-lock.json
          # åŸºäºå½“å‰node_modulesç”Ÿæˆpackage-lock.jsonï¼Œä¾›ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
          npm install --package-lock-only
          # éªŒè¯ç”Ÿæˆçš„package-lock.json
          ls -la package-lock.json

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            .next
            package.json
            package-lock.json
            ecosystem.config.js
            prisma
            generated
            next.config.js
            tsconfig.json
            public
          retention-days: 1

  # 2. æ‰“åŒ… Job
  package:
    name: Create Deployment Package
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files

      - name: Generate production environment file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env.production
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env.production
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.production
          echo "OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}" >> .env.production
          echo "OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}" >> .env.production
          echo "OSS_BUCKET=easy-erp-web" >> .env.production
          echo "OSS_REGION=oss-cn-hangzhou" >> .env.production
          echo "OSS_ENDPOINT=easy-erp-web.oss-cn-hangzhou.aliyuncs.com" >> .env.production
          echo "OSS_PATH_PREFIX=template" >> .env.production
          echo "NODE_ENV=production" >> .env.production
          echo "PORT=3008" >> .env.production

      - name: Create deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶
          tar -czf deploy.tar.gz \
            .next \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            prisma \
            generated \
            .env.production \
            next.config.js \
            tsconfig.json \
            public

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy.tar.gz
          retention-days: 1

  # 3. éƒ¨ç½² Job
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: package
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Upload to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          source: deploy.tar.gz
          target: /tmp/
          overwrite: true

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            # åˆ›å»ºé¡¹ç›®ç›®å½•
            mkdir -p /www/wwwroot/easy-erp-web

            # åœæ­¢å¹¶åˆ é™¤æ—§çš„PM2è¿›ç¨‹ï¼ˆç¡®ä¿ç«¯å£æ›´æ”¹ç”Ÿæ•ˆï¼‰
            pm2 stop easy-erp-web || true
            pm2 delete easy-erp-web || true

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "/www/wwwroot/easy-erp-web/backup" ]; then
              rm -rf /www/wwwroot/easy-erp-web/backup
            fi
            if [ -f "/www/wwwroot/easy-erp-web/package.json" ]; then
              mkdir -p /www/wwwroot/easy-erp-web/backup
              cp -r /www/wwwroot/easy-erp-web/* /www/wwwroot/easy-erp-web/backup/ 2>/dev/null || true
            fi

            # è§£å‹æ–°ç‰ˆæœ¬
            cd /www/wwwroot/easy-erp-web
            tar -xzf /tmp/deploy.tar.gz
            rm -f /tmp/deploy.tar.gz

            # è®¾ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶
            cp .env.production .env

            # å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆæœåŠ¡å™¨ä½¿ç”¨npmï¼‰
            npm install --production --omit=dev

            # æ•°æ®åº“è¿ç§»
            npx prisma generate
            npx prisma db push

            # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨åˆ™é‡Šæ”¾
            PORT_IN_USE=$(netstat -tlnp 2>/dev/null | grep ":3008 " | wc -l)
            if [ "$PORT_IN_USE" -gt 0 ]; then
              echo "ç«¯å£ 3008 è¢«å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
              lsof -ti:3008 | xargs kill -9 2>/dev/null || true
              sleep 3
            fi

            # å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰
            pm2 start ecosystem.config.js --env production

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # é‡è½½ nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
            nginx -t && nginx -s reload || true

            # æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
            pm2 status

  # 4. éƒ¨ç½²åéªŒè¯ Job
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Health check
        run: |
          echo "Waiting for application to start..."
          sleep 30

          # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.HOST }}:3008/api/health" || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Application is healthy"
          else
            echo "âŒ Application health check failed (HTTP $response)"
            exit 1
          fi

      - name: Notify deployment status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“Š åº”ç”¨çŠ¶æ€ï¼š"
            pm2 status
            echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
            df -h /www/wwwroot/easy-erp-web
            echo "ğŸ”„ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
            pm2 logs easy-erp-web --lines 10
