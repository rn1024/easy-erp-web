# æ•°æ®åº“Schemaå˜æ›´æ ‡å‡†æµç¨‹

æœ¬æ–‡æ¡£å®šä¹‰äº†Easy ERPé¡¹ç›®ä¸­æ•°æ®åº“schemaå˜æ›´çš„æ ‡å‡†æµç¨‹ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **è¿ç§»ä¼˜å…ˆ**: æ‰€æœ‰schemaå˜æ›´å¿…é¡»é€šè¿‡Prismaè¿ç§»æ–‡ä»¶å®ç°
2. **å‘åå…¼å®¹**: æ–°çš„è¿ç§»ä¸åº”ç ´åç°æœ‰åŠŸèƒ½
3. **å¤‡ä»½ä¿æŠ¤**: ç”Ÿäº§ç¯å¢ƒå˜æ›´å‰å¿…é¡»åˆ›å»ºå¤‡ä»½
4. **æµ‹è¯•éªŒè¯**: æ‰€æœ‰å˜æ›´å¿…é¡»åœ¨å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•
5. **æ–‡æ¡£è®°å½•**: é‡è¦å˜æ›´å¿…é¡»æœ‰è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜

## ğŸ“‹ å˜æ›´æµç¨‹

### 1. å¼€å‘é˜¶æ®µ

#### 1.1 ä¿®æ”¹Schemaæ–‡ä»¶
```bash
# ç¼–è¾‘ prisma/schema.prisma æ–‡ä»¶
vim prisma/schema.prisma
```

#### 1.2 åˆ›å»ºè¿ç§»æ–‡ä»¶
```bash
# åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
npx prisma migrate dev --name describe_your_change

# ç¤ºä¾‹ï¼šæ·»åŠ æ–°å­—æ®µ
npx prisma migrate dev --name add_user_avatar_field

# ç¤ºä¾‹ï¼šåˆ›å»ºæ–°è¡¨
npx prisma migrate dev --name create_audit_log_table
```

#### 1.3 éªŒè¯è¿ç§»
```bash
# æ£€æŸ¥è¿ç§»çŠ¶æ€
npx prisma migrate status

# éªŒè¯schema
npx prisma validate

# é‡æ–°ç”Ÿæˆå®¢æˆ·ç«¯
npx prisma generate
```

### 2. æµ‹è¯•é˜¶æ®µ

#### 2.1 æœ¬åœ°æµ‹è¯•
```bash
# é‡ç½®æ•°æ®åº“ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate reset

# è¿è¡Œç§å­æ•°æ®
npm run db:seed

# è¿è¡Œæµ‹è¯•å¥—ä»¶
npm test
npm run test:e2e
```

#### 2.2 åŠŸèƒ½éªŒè¯
- éªŒè¯æ–°åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- ç¡®è®¤ç°æœ‰åŠŸèƒ½æœªå—å½±å“
- æ£€æŸ¥APIç«¯ç‚¹å“åº”
- éªŒè¯å‰ç«¯ç•Œé¢æ˜¾ç¤º

### 3. éƒ¨ç½²å‡†å¤‡

#### 3.1 ä»£ç å®¡æŸ¥
- è¿ç§»æ–‡ä»¶SQLè¯­å¥å®¡æŸ¥
- Schemaå˜æ›´å½±å“è¯„ä¼°
- æ€§èƒ½å½±å“åˆ†æ
- å®‰å…¨æ€§æ£€æŸ¥

#### 3.2 éƒ¨ç½²è®¡åˆ’
- ç¡®å®šéƒ¨ç½²æ—¶é—´çª—å£
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- é€šçŸ¥ç›¸å…³äººå‘˜
- å‡†å¤‡ç›‘æ§æ–¹æ¡ˆ

### 4. ç”Ÿäº§éƒ¨ç½²

#### 4.1 éƒ¨ç½²å‰æ£€æŸ¥
```bash
# æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒè¿ç§»çŠ¶æ€
ssh production-server "cd /www/wwwroot/easy-erp-web && npx prisma migrate status"

# åˆ›å»ºæ•°æ®åº“å¤‡ä»½
ssh production-server "cd /www/wwwroot/easy-erp-web && bash scripts/db-backup.sh"
```

#### 4.2 æ‰§è¡Œéƒ¨ç½²
```bash
# ä½¿ç”¨æ ‡å‡†éƒ¨ç½²è„šæœ¬
bash scripts/deploy-to-ecs.sh
```

#### 4.3 éƒ¨ç½²åéªŒè¯
```bash
# æ£€æŸ¥è¿ç§»çŠ¶æ€
npx prisma migrate status

# éªŒè¯åº”ç”¨å¥åº·çŠ¶æ€
curl -f http://localhost:3000/api/health

# æ£€æŸ¥å…³é”®åŠŸèƒ½
# - ç”¨æˆ·ç™»å½•
# - æ•°æ®æŸ¥è¯¢
# - æ–°åŠŸèƒ½æµ‹è¯•
```

## ğŸš¨ ç´§æ€¥å›æ»š

å¦‚æœéƒ¨ç½²åå‘ç°é—®é¢˜ï¼Œç«‹å³æ‰§è¡Œå›æ»šï¼š

```bash
# æŸ¥çœ‹å¯ç”¨å¤‡ä»½
ls -la backups/backup_*.sql.gz

# æ‰§è¡Œå›æ»š
bash scripts/db-rollback.sh backups/backup_easy_erp_db_YYYYMMDD_HHMMSS.sql.gz
```

## ğŸ“ å˜æ›´ç±»å‹å’Œæ³¨æ„äº‹é¡¹

### å®‰å…¨å˜æ›´ï¼ˆæ¨èï¼‰
- âœ… æ·»åŠ æ–°è¡¨
- âœ… æ·»åŠ æ–°å­—æ®µï¼ˆå¯ç©ºæˆ–æœ‰é»˜è®¤å€¼ï¼‰
- âœ… æ·»åŠ ç´¢å¼•
- âœ… åˆ›å»ºæ–°çš„æšä¸¾å€¼

### è°¨æ…å˜æ›´ï¼ˆéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼‰
- âš ï¸ ä¿®æ”¹å­—æ®µç±»å‹
- âš ï¸ æ·»åŠ éç©ºå­—æ®µ
- âš ï¸ é‡å‘½åå­—æ®µæˆ–è¡¨
- âš ï¸ åˆ é™¤æšä¸¾å€¼

### å±é™©å˜æ›´ï¼ˆéœ€è¦ç‰¹æ®Šæµç¨‹ï¼‰
- ğŸš« åˆ é™¤è¡¨æˆ–å­—æ®µ
- ğŸš« ä¿®æ”¹ä¸»é”®
- ğŸš« åˆ é™¤ç´¢å¼•ï¼ˆå¯èƒ½å½±å“æ€§èƒ½ï¼‰

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### è¿ç§»ç®¡ç†
```bash
# æŸ¥çœ‹è¿ç§»å†å²
npx prisma migrate status

# æ ‡è®°è¿ç§»ä¸ºå·²åº”ç”¨ï¼ˆä»…åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ï¼‰
npx prisma migrate resolve --applied "20250821015630_add_shipment_file_field"

# é‡ç½®è¿ç§»å†å²ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate reset
```

### æ•°æ®åº“æ“ä½œ
```bash
# ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# éªŒè¯schema
npx prisma validate

# æŸ¥çœ‹æ•°æ®åº“å†…å®¹
npx prisma studio
```

### å¤‡ä»½å’Œæ¢å¤
```bash
# åˆ›å»ºå¤‡ä»½
bash scripts/db-backup.sh

# æ‰§è¡Œå›æ»š
bash scripts/db-rollback.sh <backup_file>
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### éƒ¨ç½²ç›‘æ§
- åº”ç”¨å¯åŠ¨çŠ¶æ€
- æ•°æ®åº“è¿æ¥çŠ¶æ€
- APIå“åº”æ—¶é—´
- é”™è¯¯æ—¥å¿—ç›‘æ§

### å…³é”®æŒ‡æ ‡
- è¿ç§»æ‰§è¡Œæ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- åº”ç”¨å†…å­˜ä½¿ç”¨
- ç”¨æˆ·è®¿é—®å¼‚å¸¸

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿ç§»å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†é”™è¯¯
   npx prisma migrate status
   
   # æ£€æŸ¥æ•°æ®åº“è¿æ¥
   npx prisma db pull
   ```

2. **Schemaä¸ä¸€è‡´**
   ```bash
   # é‡æ–°ç”Ÿæˆå®¢æˆ·ç«¯
   npx prisma generate
   
   # éªŒè¯schema
   npx prisma validate
   ```

3. **åº”ç”¨å¯åŠ¨å¤±è´¥**
   ```bash
   # æ£€æŸ¥PM2æ—¥å¿—
   pm2 logs easy-erp-web
   
   # æ£€æŸ¥æ•°æ®åº“è¿æ¥
   mysql -u erp_user -p -e "SELECT 1"
   ```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Prismaè¿ç§»æ–‡æ¡£](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [æ•°æ®åº“å¤‡ä»½ç­–ç•¥](./database-backup-strategy.md)
- [éƒ¨ç½²æµç¨‹æ–‡æ¡£](./deployment-process.md)
- [æ•…éšœæ’é™¤æŒ‡å—](./troubleshooting-guide.md)

## ğŸ”„ æµç¨‹æ”¹è¿›

æœ¬æµç¨‹ä¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µæŒç»­æ”¹è¿›ï¼Œå¦‚æœ‰å»ºè®®è¯·æäº¤Issueæˆ–PRã€‚

---

**æœ€åæ›´æ–°**: 2025-08-21  
**ç‰ˆæœ¬**: 1.0  
**ç»´æŠ¤è€…**: Easy ERPå¼€å‘å›¢é˜Ÿ
