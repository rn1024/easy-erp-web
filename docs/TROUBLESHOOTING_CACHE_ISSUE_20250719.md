# Next.js + Nginx ä»£ç†ç¼“å­˜é—®é¢˜æ’æŸ¥è®°å½•

**æ—¥æœŸ**: 2025å¹´7æœˆ19æ—¥  
**é—®é¢˜ç­‰çº§**: P1 (å½±å“çº¿ä¸ŠåŠŸèƒ½)  
**å¤„ç†æ—¶é•¿**: ~3å°æ—¶  
**æœ€ç»ˆçŠ¶æ€**: âœ… å·²è§£å†³  

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**æ ¸å¿ƒé—®é¢˜**: ä»£ç æ›´æ–°åï¼Œçº¿ä¸Šé¡µé¢ä»æ˜¾ç¤ºæ—§ç‰ˆæœ¬ï¼Œæ–°å¢çš„"åˆ†äº«ç»™ä¾›åº”å•†"åŠŸèƒ½æ— æ³•æ˜¾ç¤º

**å½±å“èŒƒå›´**: 
- çº¿ä¸Šç¯å¢ƒé‡‡è´­è®¢å•é¡µé¢åŠŸèƒ½ç¼ºå¤±
- ç”¨æˆ·æ— æ³•ä½¿ç”¨æ–°å¢çš„åˆ†äº«åŠŸèƒ½
- å¯èƒ½å½±å“å…¶ä»–ç³»ç»Ÿé¡µé¢çš„æ›´æ–°

---

## ğŸ” é—®é¢˜ç°è±¡

### 1. åˆå§‹è¡¨ç°
- **æœ¬åœ°ç¯å¢ƒ**: åˆ†äº«åŠŸèƒ½æ­£å¸¸æ˜¾ç¤ºå’Œå·¥ä½œ
- **çº¿ä¸Šç¯å¢ƒ**: é‡‡è´­è®¢å•é¡µé¢ç¼ºå°‘åˆ†äº«æŒ‰é’®
- **æµè§ˆå™¨æ˜¾ç¤º**: é¡µé¢åŠ è½½æ­£å¸¸ï¼Œä½†åŠŸèƒ½ç¼ºå¤±

### 2. æŠ€æœ¯è¡¨ç°
```bash
# æµè§ˆå™¨è¯·æ±‚çš„JSæ–‡ä»¶ï¼ˆæ—§ç‰ˆæœ¬ï¼‰
page-90088224ec7d410b.js

# æœåŠ¡å™¨å®é™…çš„JSæ–‡ä»¶ï¼ˆæ–°ç‰ˆæœ¬ï¼‰  
page-e9a85cad20fc736e.js
```

### 3. æ„å»ºé”™è¯¯
```bash
DOMException [DataCloneError]: #<Object> could not be cloned.
Error: Collecting page data for /system/accounts is still timing out after 2 attempts.
```

---

## ğŸ•µï¸ æ’æŸ¥è¿‡ç¨‹

### é˜¶æ®µ1: è¯¯å…¥æ­§é€”çš„ç¼“å­˜å‡è®¾ âŒ

**é”™è¯¯å‡è®¾**: Next.jsé¡µé¢ç¼“å­˜é—®é¢˜
**å°è¯•æ–¹æ¡ˆ**:
- åˆ›å»º`src/app/system/layout.tsx`æ·»åŠ `dynamic = 'force-dynamic'`
- æ¸…ç†`.next/cache`ç›®å½•
- ä¿®æ”¹next.config.jsç¼“å­˜é…ç½®

**ç»“æœ**: é—®é¢˜æœªè§£å†³ï¼Œåå¤å°è¯•20+æ¬¡

### é˜¶æ®µ2: æ·±å…¥æœåŠ¡å™¨ç¯å¢ƒåˆ†æ âœ…

**å…³é”®å‘ç°**:
1. **ç™»å½•çº¿ä¸Šç¯å¢ƒå®é™…æµ‹è¯•**
   ```bash
   # ç›´æ¥è®¿é—®Next.jsåº”ç”¨(3008ç«¯å£)
   curl http://localhost:3008/system/purchase-orders | grep page-
   # è¾“å‡º: page-e9a85cad20fc736e.js (æ–°ç‰ˆæœ¬)
   
   # é€šè¿‡nginxè®¿é—®
   curl https://erp.samuelcn.com/system/purchase-orders | grep page-
   # è¾“å‡º: page-90088224ec7d410b.js (æ—§ç‰ˆæœ¬)
   ```

2. **å‘ç°nginxä»£ç†ç¼“å­˜é…ç½®**
   ```nginx
   proxy_cache_path /www/server/nginx/proxy_cache_dir levels=1:2 keys_zone=cache_one:20m inactive=1d max_size=5g;
   proxy_cache cache_one;
   ```

### é˜¶æ®µ3: PM2é…ç½®é—®é¢˜å‘ç° âœ…

**å‘ç°standaloneæ¨¡å¼é…ç½®é”™è¯¯**:
```javascript
// é”™è¯¯é…ç½®
script: 'npm',
args: 'start'

// æ­£ç¡®é…ç½®
script: '.next/standalone/server.js'
```

### é˜¶æ®µ4: é™æ€èµ„æºç¼ºå¤±é—®é¢˜ âœ…

**å‘ç°standaloneæ¨¡å¼é™æ€èµ„æºæœªå¤åˆ¶**:
- `.next/standalone/.next/static/` ç›®å½•ç¼ºå¤±
- `public/` ç›®å½•å†…å®¹æœªå¤åˆ¶åˆ°standalone

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### 1. ä¸»è¦åŸå› : Nginxä»£ç†ç¼“å­˜
```nginx
# å…¨å±€å¯ç”¨ä»£ç†ç¼“å­˜ï¼Œç¼“å­˜1å¤©
proxy_cache cache_one;
inactive=1d

# è™½ç„¶æ·»åŠ äº†no-cacheå¤´ï¼Œä½†nginxä»ç„¶ç¼“å­˜å“åº”
add_header Cache-Control no-cache;
```

**é—®é¢˜**: nginxçš„`proxy_cache`ä¼šå¿½ç•¥å“åº”å¤´ä¸­çš„`Cache-Control: no-cache`ï¼Œç»§ç»­ç¼“å­˜HTMLé¡µé¢

### 2. æ¬¡è¦åŸå› : PM2é…ç½®ä¸å½“
```javascript
// ä½¿ç”¨npm startè€Œéstandaloneæ¨¡å¼
script: 'npm',
args: 'start'
```

**é—®é¢˜**: æœªå……åˆ†åˆ©ç”¨Next.js standaloneæ¨¡å¼çš„æ€§èƒ½ä¼˜åŠ¿

### 3. è¾…åŠ©åŸå› : é™æ€èµ„æºå¤åˆ¶ä¸å®Œæ•´
**é—®é¢˜**: standaloneæ¨¡å¼éœ€è¦æ‰‹åŠ¨å¤åˆ¶`.next/static`å’Œ`public`ç›®å½•

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ç«‹å³è§£å†³æ–¹æ¡ˆ: å…³é—­nginxä»£ç†ç¼“å­˜

```bash
# æ¸…ç†ç°æœ‰ç¼“å­˜
rm -rf /www/server/nginx/proxy_cache_dir/*

# ä¿®æ”¹åå‘ä»£ç†é…ç½®
# åœ¨ /www/server/panel/vhost/nginx/proxy/erp.samuelcn.com/*.conf ä¸­æ·»åŠ :
proxy_cache off;

# é‡æ–°åŠ è½½nginx
nginx -s reload
```

### 2. ä¼˜åŒ–PM2é…ç½®

```javascript
// ecosystem.config.js
{
  name: 'easy-erp-web',
  script: '.next/standalone/server.js',  // ä½¿ç”¨standaloneæ¨¡å¼
  // å…¶ä»–é…ç½®...
}
```

### 3. å®Œå–„éƒ¨ç½²è„šæœ¬

```bash
# scripts/deploy-standalone.sh
# 1. æ„å»ºåº”ç”¨
pnpm build

# 2. å¤åˆ¶é™æ€èµ„æº
cp -r .next/static .next/standalone/.next/

# 3. å¤åˆ¶publicç›®å½•
cp -r public/* .next/standalone/public/

# 4. åˆ›å»ºfavicon.ico
cp .next/standalone/public/favicon.svg .next/standalone/public/favicon.ico
```

---

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. éƒ¨ç½²æµç¨‹ä¼˜åŒ–

**æ–°å¢è‡ªåŠ¨åŒ–è„šæœ¬**:
```bash
# ä½¿ç”¨æ”¹è¿›çš„æ„å»ºå‘½ä»¤
pnpm build:standalone
```

**è„šæœ¬åŠŸèƒ½**:
- è‡ªåŠ¨å¤åˆ¶æ‰€æœ‰å¿…éœ€çš„é™æ€èµ„æº
- éªŒè¯æ„å»ºäº§ç‰©å®Œæ•´æ€§
- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

### 2. ç›‘æ§æœºåˆ¶

**å»ºè®®æ·»åŠ **:
- éƒ¨ç½²åè‡ªåŠ¨åŠŸèƒ½éªŒè¯
- é™æ€èµ„æºç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
- ç¼“å­˜çŠ¶æ€ç›‘æ§

### 3. æ–‡æ¡£å’Œè§„èŒƒ

**æ›´æ–°æ–‡æ¡£**:
- éƒ¨ç½²SOPå¢åŠ é™æ€èµ„æºæ£€æŸ¥æ­¥éª¤
- nginxé…ç½®æœ€ä½³å®è·µ
- standaloneæ¨¡å¼éƒ¨ç½²æŒ‡å—

---

## ğŸ“ ç»éªŒæ€»ç»“

### âœ… æ­£ç¡®çš„æ’æŸ¥æ–¹æ³•

1. **ç³»ç»Ÿæ€§åˆ†æ**: ä»æµè§ˆå™¨â†’nginxâ†’Next.jså®Œæ•´é“¾è·¯åˆ†æ
2. **å®é™…ç¯å¢ƒæµ‹è¯•**: ç›´æ¥ç™»å½•æœåŠ¡å™¨éªŒè¯ï¼Œè€Œéä»…çœ‹æ—¥å¿—
3. **å¯¹æ¯”éªŒè¯**: æœ¬åœ°vsæœåŠ¡å™¨ï¼Œç›´è¿vsä»£ç†çš„å¯¹æ¯”
4. **æ ¹å› åˆ†æ**: æ·±å…¥åˆ°é…ç½®å±‚é¢æ‰¾æ ¹æœ¬åŸå› 

### âŒ é”™è¯¯çš„æ’æŸ¥æ–¹æ³•

1. **ç›²ç›®å‡è®¾**: æœªéªŒè¯å°±è®¤ä¸ºæ˜¯Next.jsç¼“å­˜é—®é¢˜
2. **é‡å¤å°è¯•**: åœ¨é”™è¯¯æ–¹å‘ä¸Šåå¤å°è¯•20+æ¬¡
3. **è¡¨é¢ä¿®å¤**: åªå…³æ³¨è¡¨è±¡ï¼Œæœªæ‰¾åˆ°æ ¹æœ¬åŸå› 
4. **ç¼ºä¹éªŒè¯**: æœªé€šè¿‡å®é™…æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ

### ğŸ“ å…³é”®å­¦ä¹ ç‚¹

1. **nginxä»£ç†ç¼“å­˜çš„å½±å“**
   - `proxy_cache`ä¼šç¼“å­˜æ‰€æœ‰å“åº”ï¼ŒåŒ…æ‹¬HTML
   - ä»…è®¾ç½®å“åº”å¤´æ— æ³•é˜»æ­¢nginxç¼“å­˜
   - éœ€è¦ä½¿ç”¨`proxy_no_cache`å’Œ`proxy_cache_bypass`

2. **Next.js standaloneæ¨¡å¼**
   - éœ€è¦æ‰‹åŠ¨å¤åˆ¶é™æ€èµ„æºå’Œpublicç›®å½•
   - æ¯”npm startæ¨¡å¼æ€§èƒ½æ›´å¥½
   - æ„å»ºäº§ç‰©æ›´ç‹¬ç«‹ï¼Œä¾¿äºéƒ¨ç½²

3. **é—®é¢˜æ’æŸ¥çš„é‡è¦æ€§**
   - è¦æœ‰ç³»ç»Ÿæ€§æ€ç»´ï¼Œä¸èƒ½å¤´ç—›åŒ»å¤´
   - è¦éªŒè¯å‡è®¾ï¼Œä¸èƒ½å‡­æ„Ÿè§‰
   - è¦è®°å½•è¿‡ç¨‹ï¼Œä¾¿äºå¤ç›˜

---

## ğŸ”— ç›¸å…³èµ„æº

- [Next.js Standalone Mode Documentation](https://nextjs.org/docs/pages/api-reference/next-config-js/output)
- [Nginx Proxy Cache Configuration](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache)
- [é¡¹ç›®éƒ¨ç½²è„šæœ¬](../scripts/deploy-standalone.sh)
- [PM2 é…ç½®æ–‡ä»¶](../ecosystem.config.js)

---

**è®°å½•äºº**: AI Assistant  
**å®¡æ ¸äºº**: å¾…è¡¥å……  
**å½’æ¡£æ—¥æœŸ**: 2025å¹´7æœˆ19æ—¥ 
